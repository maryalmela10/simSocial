{% extends 'base.html.twig' %}

{% block title %}Perfil de {{ app.user.nombre }}{% endblock %}
{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('css/stylesheetComentarios.css') }}" rel="stylesheet" type="text/css">
{% endblock %}

{% block contenido %}
    <div class="profile-container">
        <div class="post-container">
            <p>{{ post.contenido }}</p>
            
            <!-- Secci√≥n de reacciones -->
            <div class="btn-reaccion" data-post-id="{{ post.id }}" data-tipo="me_gusta">
                üëç Me Gusta <span id="likes-{{ post.id }}">{{ post.contarReacciones('me_gusta') }}</span>
            </div>
            <div class="btn-reaccion" data-post-id="{{ post.id }}" data-tipo="no_me_gusta">
                üëé No Me Gusta <span id="dislikes-{{ post.id }}">{{ post.contarReacciones('no_me_gusta') }}</span>
            </div>
        </div>

        <div class="profile-info">
            <h2>Comentarios</h2>
            {% for comentario in comentarios %}
                <div>
                    <strong>{{ comentario.usuario.getUserIdentifier() }}</strong>  
                    <span>{{ comentario.fechaComentario|date('d-m-Y H:i') }}</span>
                    <p>{{ comentario.contenido }}</p>
                </div>
            {% else %}
                <p>No hay comentarios a√∫n.</p>
            {% endfor %}
        </div>

        <h3>A√±adir un comentario</h3>
        <form action="{{ path('agregar_comentario', {'id': post.id}) }}" method="POST">
            <textarea name="contenido" required></textarea>
            <button type="submit">Comentar</button>
        </form>
    </div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".btn-reaccion").forEach(button => {
        button.addEventListener("click", function () {
            const postId = this.dataset.postId;
            const tipo = this.dataset.tipo;

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/post/" + postId + "/reaccionar", true);
            xhr.setRequestHeader("Content-Type", "application/json");

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var data = JSON.parse(xhr.responseText);
                        document.getElementById(`likes-${postId}`).textContent = data.likes;
                        document.getElementById(`dislikes-${postId}`).textContent = data.dislikes;
                    } else {
                        console.error("Error en la solicitud: " + xhr.status);
                    }
                }
            };

            xhr.send(JSON.stringify({ tipo: tipo }));
        });
    });
});
</script>

{% endblock %}
