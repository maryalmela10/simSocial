{% extends 'base.html.twig' %}

{% block title %}Perfil de {{ usuario.nombre ~ ' ' ~ usuario.apellido}}{% endblock %}
{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('css/stylesheetPerfilOtro.css') }}" rel="stylesheet" type="text/css">
{% endblock %}


{% block contenido %}
    {% if amistad and amistad.estado == 'aceptado' %}
        <h1>{{ usuario.nombre|capitalize }} {{ usuario.apellido|capitalize }}</h1>
        <div class="posts-list">
            {% for post in posts %}
            <div class="post">
                <p>{{ post.contenido }}</p>
                <small>
                    Publicado el {{ post.fecha_publicacion|date("d/m/Y") }} a las {{ post.fecha_publicacion|date("H:i") }} - Comentarios: {{ post.comentarios|length }}
                </small>
                <br>
                <a href="{{ path('ver_post', { id: post.id }) }}">Ver m√°s</a> {# Enlace al detalle del post #}
            </div>
            {% endfor %}
        </div>
    {% elseif amistad and amistad.estado == 'pendiente' %}
          <div class="solicitud-amistad">
            <p>Tienes una solicitud de amistad pendiente con este usuario.</p>
            {% if enviado_para_actual %}
                <button onclick="gestionarSolicitudAmistad({{ usuario.id }}, 'aceptar')">Aceptar</button>
                <button onclick="gestionarSolicitudAmistad({{ usuario.id }}, 'rechazar')">Rechazar</button>
            {% endif %}
        </div>
    {% else %}
        <div class="solicitud-amistad">
            <p>No tienes acceso al perfil completo de este usuario.</p>
            <button onclick="enviarSolicitudAmistad({{ usuario.id }})">Enviar solicitud de amistad</button>
        </div>
{% endif %}
    <div id="mensaje-solicitud" style="display: none;"></div>
{% endblock %}
{% block javascripts %}
    <script>
          function gestionarSolicitudAmistad(usuarioAmigo, accion) {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                var respuesta = JSON.parse(this.responseText);
                var mensajeDiv = document.getElementById("mensaje-solicitud");
                mensajeDiv.innerHTML = respuesta.message;
                mensajeDiv.style.display = "block"; 
                }
            };
            xhttp.open("POST", "/gestionar-solicitud-amistad", true);
            xhttp.setRequestHeader("Content-type", "application/json");
            xhttp.setRequestHeader("X-Requested-With", "XMLHttpRequest");
            xhttp.send(JSON.stringify({ 
                usuarioAmigo: usuarioAmigo,
                accion: accion 
            }));
        }

        function enviarSolicitudAmistad(idUsuario) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var respuesta = JSON.parse(this.responseText);
                var mensajeDiv = document.getElementById("mensaje-solicitud");
                mensajeDiv.innerHTML = respuesta.message;
                mensajeDiv.style.display = "block";
            }
        };
        xhttp.open("POST", "/solicitud-amistad/" + idUsuario, true);
        xhttp.setRequestHeader("Content-type", "application/json");
        xhttp.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xhttp.send();
        return false;
    }
    </script>
{% endblock %}

